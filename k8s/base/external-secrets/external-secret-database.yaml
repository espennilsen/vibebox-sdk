---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: vibebox-database
  namespace: default
spec:
  refreshInterval: 1h  # Refresh every hour
  secretStoreRef:
    name: vibebox-aws-secretstore  # Change to your SecretStore name
    kind: SecretStore
  target:
    name: vibebox-database  # Name of the Kubernetes Secret to create
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # Database connection string
        DATABASE_URL: "postgresql://{{ .db_user }}:{{ .db_password }}@{{ .db_host }}:{{ .db_port }}/{{ .db_name }}?schema=public"
        # Individual components (if needed)
        POSTGRES_USER: "{{ .db_user }}"
        POSTGRES_PASSWORD: "{{ .db_password }}"
        POSTGRES_HOST: "{{ .db_host }}"
        POSTGRES_PORT: "{{ .db_port }}"
        POSTGRES_DB: "{{ .db_name }}"
  dataFrom:
    # Option 1: Get all secrets from a single secret object
    - extract:
        key: vibebox/database  # AWS Secrets Manager secret name
    # Option 2: Get individual secrets
  # data:
  #   - secretKey: db_user
  #     remoteRef:
  #       key: vibebox/database-user
  #   - secretKey: db_password
  #     remoteRef:
  #       key: vibebox/database-password
  #   - secretKey: db_host
  #     remoteRef:
  #       key: vibebox/database-host
  #   - secretKey: db_port
  #     remoteRef:
  #       key: vibebox/database-port
  #       property: port  # For nested JSON values
  #   - secretKey: db_name
  #     remoteRef:
  #       key: vibebox/database-name
