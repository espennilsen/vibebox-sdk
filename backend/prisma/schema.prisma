// Prisma Schema - Task T004
// Database schema for VibeBox based on data-model.md
// Generated from specs/001-develop-vibecode-a/data-model.md

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// User entity - Represents a developer using VibeBox
model User {
  id                     String    @id @default(uuid())
  email                  String    @unique
  passwordHash           String?   @map("password_hash")
  displayName            String    @map("display_name")
  avatarUrl              String?   @map("avatar_url")
  timezone               String    @default("UTC")
  locale                 String    @default("en-US")
  sshPublicKey           String?   @map("ssh_public_key") @db.Text
  notificationSettings   Json      @default("{}") @map("notification_settings")
  maxEnvironments        Int       @default(10) @map("max_environments")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")
  lastLoginAt            DateTime? @map("last_login_at")

  // Relationships
  ownedProjects   Project[]       @relation("ProjectOwner")
  userTeams       UserTeam[]
  environments    Environment[]   @relation("EnvironmentCreator")
  apiKeys         ApiKey[]

  @@index([createdAt])
  @@map("users")
}

/// Team entity - Represents an organization or team
model Team {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description     String?  @db.Text
  avatarUrl       String?  @map("avatar_url")
  maxEnvironments Int      @default(50) @map("max_environments")
  maxMembers      Int      @default(20) @map("max_members")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relationships
  userTeams UserTeam[]
  projects  Project[]  @relation("TeamOwner")

  @@index([name])
  @@map("teams")
}

/// UserTeam junction - User-Team many-to-many with roles
model UserTeam {
  id       String               @id @default(uuid())
  userId   String               @map("user_id")
  teamId   String               @map("team_id")
  role     UserTeamRole
  joinedAt DateTime             @default(now()) @map("joined_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
  @@index([userId, role])
  @@map("user_teams")
}

enum UserTeamRole {
  admin
  developer
  viewer
}

/// Project entity - Organizational unit grouping environments
model Project {
  id          String   @id @default(uuid())
  name        String
  slug        String
  description String?  @db.Text
  ownerId     String?  @map("owner_id")
  teamId      String?  @map("team_id")
  isArchived  Boolean  @default(false) @map("is_archived")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  owner        User?         @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  team         Team?         @relation("TeamOwner", fields: [teamId], references: [id], onDelete: Cascade)
  environments Environment[]

  @@unique([slug, ownerId])
  @@unique([slug, teamId])
  @@index([ownerId])
  @@index([teamId])
  @@index([teamId, isArchived])
  @@index([ownerId, isArchived])
  @@map("projects")
}

/// Environment entity - Docker-based development environment
model Environment {
  id            String            @id @default(uuid())
  name          String
  slug          String
  description   String?           @db.Text
  projectId     String            @map("project_id")
  creatorId     String            @map("creator_id")
  baseImage     String            @map("base_image")
  containerId   String?           @map("container_id")
  status        EnvironmentStatus
  errorMessage  String?           @map("error_message") @db.Text
  cpuLimit      Decimal           @default(2.0) @map("cpu_limit") @db.Decimal(4, 2)
  memoryLimit   Int               @default(4096) @map("memory_limit")
  storageLimit  Int               @default(20480) @map("storage_limit")
  ephemeral     Boolean           @default(false)
  expiresAt     DateTime?         @map("expires_at")
  pausedAt      DateTime?         @map("paused_at")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")
  startedAt     DateTime?         @map("started_at")
  stoppedAt     DateTime?         @map("stopped_at")

  // Relationships
  project               Project                 @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator               User                    @relation("EnvironmentCreator", fields: [creatorId], references: [id])
  sessions              Session[]
  environmentExtensions EnvironmentExtension[]
  ports                 EnvironmentPort[]
  variables             EnvironmentVariable[]
  logs                  LogEntry[]
  gitConfig             SandboxGitConfig?
  executions            Execution[]

  @@unique([projectId, slug])
  @@index([projectId])
  @@index([creatorId])
  @@index([status])
  @@index([containerId])
  @@index([creatorId, status])
  @@index([projectId, status])
  @@index([expiresAt])
  @@map("environments")
}

enum EnvironmentStatus {
  stopped
  starting
  running
  stopping
  paused
  error
}

/// EnvironmentPort entity - Port mappings for network access
model EnvironmentPort {
  id            String   @id @default(uuid())
  environmentId String   @map("environment_id")
  containerPort Int      @map("container_port")
  hostPort      Int?     @map("host_port")
  protocol      Protocol @default(tcp)
  description   String?

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, containerPort])
  @@index([environmentId])
  @@index([hostPort])
  @@map("environment_ports")
}

enum Protocol {
  tcp
  udp
}

/// EnvironmentVariable entity - Environment variables for container runtime
model EnvironmentVariable {
  id            String   @id @default(uuid())
  environmentId String   @map("environment_id")
  key           String
  value         String   @db.Text
  isEncrypted   Boolean  @default(false) @map("is_encrypted")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, key])
  @@map("environment_variables")
}

/// Session entity - Active processes inside an environment
model Session {
  id                 String        @id @default(uuid())
  environmentId      String        @map("environment_id")
  sessionType        SessionType   @map("session_type")
  sessionName        String        @map("session_name")
  status             SessionStatus
  connectionUrl      String?       @map("connection_url")
  pid                Int?
  createdAt          DateTime      @default(now()) @map("created_at")
  lastActivityAt     DateTime      @default(now()) @map("last_activity_at")
  idleTimeoutMinutes Int           @default(30) @map("idle_timeout_minutes")
  terminatedAt       DateTime?     @map("terminated_at")

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@unique([environmentId, sessionType, sessionName])
  @@index([environmentId])
  @@index([status])
  @@index([lastActivityAt])
  @@index([environmentId, status])
  @@map("sessions")
}

enum SessionType {
  vscode_server
  tmux
  shell
}

enum SessionStatus {
  starting
  active
  idle
  terminated
}

/// Extension entity - VS Code extension metadata (catalog)
model Extension {
  id          String    @id @default(uuid())
  extensionId String    @unique @map("extension_id")
  name        String
  version     String
  description String?   @db.Text
  publisher   String
  iconUrl     String?   @map("icon_url")
  isCustom    Boolean   @default(false) @map("is_custom")
  downloadUrl String?   @map("download_url")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relationships
  environmentExtensions EnvironmentExtension[]

  @@index([publisher])
  @@index([isCustom])
  @@map("extensions")
}

/// EnvironmentExtension junction - Environment-Extension with installation status
model EnvironmentExtension {
  id            String                     @id @default(uuid())
  environmentId String                     @map("environment_id")
  extensionId   String                     @map("extension_id")
  status        EnvironmentExtensionStatus
  errorMessage  String?                    @map("error_message") @db.Text
  installedAt   DateTime?                  @map("installed_at")
  createdAt     DateTime                   @default(now()) @map("created_at")

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)
  extension   Extension   @relation(fields: [extensionId], references: [id], onDelete: Cascade)

  @@unique([environmentId, extensionId])
  @@index([environmentId])
  @@index([extensionId])
  @@index([status])
  @@map("environment_extensions")
}

enum EnvironmentExtensionStatus {
  pending
  installing
  installed
  failed
  uninstalling
}

/// LogEntry entity - Persistent log storage for environments
model LogEntry {
  id            String    @id @default(uuid())
  environmentId String    @map("environment_id")
  timestamp     DateTime
  stream        LogStream
  message       String    @db.Text
  createdAt     DateTime  @default(now()) @map("created_at")

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@index([environmentId, timestamp(sort: Desc)])
  @@index([createdAt])
  @@map("log_entries")
}

enum LogStream {
  stdout
  stderr
}

/// AuditLog entity - Tracks sensitive operations for security and compliance
model AuditLog {
  id          String       @id @default(uuid())
  userId      String?      @map("user_id")
  action      AuditAction
  resource    String       // Resource type (user, environment, project, etc.)
  resourceId  String?      @map("resource_id")
  details     Json?        // Additional context (IP, user agent, changes, etc.)
  severity    AuditSeverity
  ipAddress   String?      @map("ip_address")
  userAgent   String?      @map("user_agent") @db.Text
  success     Boolean      @default(true)
  errorMessage String?     @map("error_message") @db.Text
  timestamp   DateTime     @default(now())

  @@index([userId, timestamp(sort: Desc)])
  @@index([action, timestamp(sort: Desc)])
  @@index([resource, resourceId])
  @@index([timestamp(sort: Desc)])
  @@index([severity])
  @@map("audit_logs")
}

enum AuditAction {
  // Authentication
  auth_login_success
  auth_login_failed
  auth_logout
  auth_register
  auth_password_change
  auth_password_reset
  auth_token_refresh

  // User management
  user_create
  user_update
  user_delete
  user_role_change

  // Environment management
  environment_create
  environment_start
  environment_stop
  environment_delete
  environment_update
  environment_access

  // Project management
  project_create
  project_update
  project_delete
  project_archive

  // Team management
  team_create
  team_update
  team_delete
  team_member_add
  team_member_remove
  team_role_change

  // Secrets and sensitive data
  secret_access
  secret_create
  secret_update
  secret_delete
  env_var_create
  env_var_update
  env_var_delete

  // System operations
  system_config_change
  system_backup
  system_restore
}

enum AuditSeverity {
  low      // Routine operations
  medium   // Important operations
  high     // Sensitive operations
  critical // Security-critical operations
}

/// ApiKey entity - API key authentication for programmatic access
model ApiKey {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  name        String
  keyHash     String   @unique @map("key_hash")
  keyPrefix   String   @map("key_prefix")
  scopes      String[] // read, write, execute
  expiresAt   DateTime? @map("expires_at")
  lastUsedAt  DateTime? @map("last_used_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relationships
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([keyPrefix])
  @@index([expiresAt])
  @@map("api_keys")
}

/// SandboxGitConfig entity - Git repository configuration for sandboxes
model SandboxGitConfig {
  id            String   @id @default(uuid())
  environmentId String   @unique @map("environment_id")
  repoUrl       String   @map("repo_url")
  branch        String   @default("main")
  path          String   @default("/repo")
  depth         Int?     // shallow clone depth
  authType      GitAuthType @map("auth_type")
  authToken     String?  @map("auth_token") @db.Text // encrypted
  lastSyncAt    DateTime? @map("last_sync_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@index([environmentId])
  @@map("sandbox_git_configs")
}

enum GitAuthType {
  token
  ssh
  none
}

/// Execution entity - Code execution history
model Execution {
  id            String          @id @default(uuid())
  environmentId String          @map("environment_id")
  userId        String          @map("user_id")
  code          String          @db.Text
  language      String
  status        ExecutionStatus
  stdout        String?         @db.Text
  stderr        String?         @db.Text
  exitCode      Int?            @map("exit_code")
  duration      Int?            // milliseconds
  timeout       Int             @default(30000)
  env           Json?           // environment variables
  startedAt     DateTime?       @map("started_at")
  completedAt   DateTime?       @map("completed_at")
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relationships
  environment Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  @@index([environmentId])
  @@index([userId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("executions")
}

enum ExecutionStatus {
  pending
  running
  completed
  failed
  timeout
  cancelled
}

/// Template entity - Sandbox templates for quick environment creation
model Template {
  id          String   @id @default(uuid())
  name        String   @unique
  displayName String   @map("display_name")
  description String?  @db.Text
  baseImage   String   @map("base_image")
  category    String?  // nodejs, python, java, etc.
  tags        String[]
  config      Json     // default CPU, memory, storage, ports, extensions
  isPublic    Boolean  @default(true) @map("is_public")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([isPublic, isActive])
  @@map("templates")
}
